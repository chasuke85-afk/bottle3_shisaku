<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ€§ç™–ç“¶ã‚¯ã‚¤ã‚º - SEIHEKI BIN QUIZ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg: #fdfbfb; --accent: #ff4d79; --blue: #6366f1; --rule-color: #e63946; --guide-blue: #4361ee; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        input[type="text"] { -webkit-user-select: text; user-select: text; }

        body { font-family: sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 0; color: #444; margin: 0; padding-top: 60px; }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .g-nav { position: fixed; top: 0; width: 100%; height: 50px; background: #fff; display: flex; border-bottom: 1px solid #eee; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; color: #aaa; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #fffafa; }

        .main-title { font-size: 1.4rem; font-weight: bold; margin: 20px 0; letter-spacing: 1px; color: #333; }

        /* ãƒœãƒƒã‚¯ã‚¹å…±é€š */
        .box-common { width: 92%; max-width: 500px; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .box-title { font-size: 0.9rem; font-weight: bold; text-align: center; margin-bottom: 10px; display: block; }
        
        .rule-box { border: 2px solid var(--rule-color); background: #fff5f5; }
        .rule-box .box-title { color: var(--rule-color); }
        
        .guide-box { border: 2px solid var(--guide-blue); background: #f5f8ff; }
        .guide-box .box-title { color: var(--guide-blue); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .visual-guide { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 20px 0; background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .v-bar { height: 30px; display: flex; align-items: center; color: white; font-size: 0.6rem; font-weight: bold; padding: 0 5px; }

        /* ãƒœãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        .container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 95%; max-width: 900px; }
        .bottle-card { background: white; border-radius: 15px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; position: relative; }
        .bottle-frame { width: 55px; height: 85px; border: 3px solid #333; border-radius: 2px 2px 18px 18px; margin: 10px auto; position: relative; overflow: hidden; background: #eee; }
        .liquid { position: absolute; bottom: 0; width: 100%; transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .p-btn { width: 35px; height: 35px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 1.2rem; cursor: pointer; touch-action: manipulation; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn { padding: 10px 20px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-rule { background: var(--rule-color); color: white; font-size: 0.75rem; }
        .btn-random { background: #555; color: white; margin-bottom: 15px; font-size: 0.8rem; }
        .btn-main { background: var(--accent); color: white; width: 90%; max-width: 300px; margin: 30px 0; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 77, 121, 0.3); }

        /* ç­”ãˆåˆã‚ã›ç”»é¢ */
        #resultArea { display: none; width: 95%; max-width: 600px; background: white; border-radius: 20px; padding: 20px; text-align: center; margin-top: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .score-circle { width: 120px; height: 120px; border: 8px solid var(--accent); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 15px; }
        .score-num { font-size: 2.2rem; font-weight: bold; color: var(--accent); }
        .diff-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #eee; margin-top: 5px; }
    </style>
</head>
<body>

    <nav class="g-nav">
        <div class="nav-item active" id="nav-make" onclick="location.href=window.location.pathname">ã‚¯ã‚¤ã‚ºã‚’ä½œã‚‹</div>
        <div class="nav-item" id="nav-solve">ã‚¯ã‚¤ã‚ºã‚’å½“ã¦ã‚‹</div>
    </nav>

    <div id="setupView" style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div class="main-title" id="pageTitle">æ€§ç™–ç“¶ã‚¯ã‚¤ã‚ºä½œæˆä¸­</div>

        <div class="box-common rule-box">
            <span class="box-title">â—€ï¸ æ€§ç™–ç“¶ã®ãƒ«ãƒ¼ãƒ« â–¶ï¸</span>
            <div style="display:flex; justify-content:center;">
                <button class="btn btn-rule" onclick="toggleModal(true)">ãƒ«ãƒ¼ãƒ«ãƒ»åˆ¤å®šåŸºæº–ã‚’è¦‹ã‚‹</button>
            </div>
        </div>

        <div class="box-common guide-box" id="guideBox">
            <span class="box-title">ã€œ ã‚¯ã‚¤ã‚ºç™ºè¡Œã¾ã§ã®æµã‚Œ ã€œ</span>
            <div style="font-size: 0.75rem; line-height: 1.8; color: var(--guide-blue); font-weight: bold; text-align: center;">
                1. ğŸ²ãƒœã‚¿ãƒ³ã§20å€‹ã®ç“¶ã‚’ã‚»ãƒƒãƒˆã™ã‚‹<br>
                2. è‡ªåˆ†ã®æ€§ç™–ã‚’ã€Œè‰²ã€ã¨ã€Œé‡ã€ã§æ³¨ã<br>
                3. ã€Œã‚¯ã‚¤ã‚ºã‚’ç™ºè¡Œã€ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±ºã‚ã‚‹
            </div>
        </div>

        <button class="btn btn-random" onclick="generateRandom20()">ğŸ² ãŠã™ã™ã‚20é …ç›®ã‚’ã‚»ãƒƒãƒˆ</button>

        <div class="container" id="bottleContainer"></div>

        <button class="btn btn-main" id="actionBtn" onclick="publishQuiz()">âš¡ï¸ ã‚¯ã‚¤ã‚ºãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œï¼</button>
    </div>

    <div id="resultArea">
        <h2 id="resultTitle">æ¡ç‚¹çµæœ</h2>
        <div class="score-circle">
            <div style="font-size: 0.7rem;">ä¸€è‡´ç‡</div>
            <div class="score-num" id="totalScore">0%</div>
        </div>
        <h3 id="rankTitle" style="color: var(--accent); margin-bottom: 20px;">ç§°å·ï¼šé‘‘å®šå£«</h3>
        <p id="rankComment" style="font-size: 0.85rem; color: #666; margin-bottom: 30px;"></p>
        <div id="comparisonList"></div>
        <button class="btn btn-random" onclick="location.reload()">è‡ªåˆ†ã‚‚ã‚¯ã‚¤ã‚ºã‚’ä½œã‚‹</button>
    </div>

    <div class="modal-overlay" id="ruleModal" onclick="toggleModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">å¥½ãã‹ã€å«Œã„ã‹ã€‚ğŸ˜¡</h3>
            <p style="font-size: 0.8rem; color: #666; line-height: 1.6;">
                æ—¥æœ¬äººã®æ‚ªã„ç™–ã€Œæ™®é€šã€ã¯ç¦æ­¢ã§ã™ï¼<br>
                å°‘ã—ã§ã‚‚ã€Œè‰¯ã„ã€ã¨æ€ãˆã°èµ¤ã€<br>ã€Œè‹¦æ‰‹ã€ãªã‚‰é’ã‚’å¿…ãšé¸ã‚“ã§ãã ã•ã„ã€‚
            </p>
            <div class="visual-guide">
                <span style="font-size:0.7rem;">å¥½ã</span>
                <div class="v-bar" style="background:var(--accent); width:50px; border-radius: 5px 0 0 5px;">MAX</div>
                <div class="v-bar" style="background:var(--accent); width:20px; opacity:0.3;">1%</div>
                <div style="width:2px; height:40px; background:#333; margin:0 5px;"></div>
                <div class="v-bar" style="background:var(--blue); width:20px; opacity:0.3;">1%</div>
                <div class="v-bar" style="background:var(--blue); width:50px; border-radius: 0 5px 5px 0;">MAX</div>
                <span style="font-size:0.7rem;">è‹¦æ‰‹</span>
            </div>
            <p style="font-size: 0.75rem; font-weight: bold; color: var(--rule-color); margin-bottom: 20px;">
                â€»ã€Œç©ºã£ã½ã€ã®ç“¶ã¯ä½œã‚Œã¾ã›ã‚“ï¼ğŸ˜¡
            </p>
            <button class="btn btn-random" style="width:100%;" onclick="toggleModal(false)">ç†è§£ã—ã¾ã—ãŸï¼</button>
        </div>
    </div>

    <script>
        const ALL_ITEMS = ['é•·èº«','å°æŸ„','è¤è‰²','å·¨ä¹³','è²§ä¹³','ãŠå°»','æ‰‹','ç”Ÿè¶³','ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢','ãƒ­ãƒ³ã‚°ãƒ˜ã‚¢','ãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«','ãƒ„ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ«','ä½“æ ¼å·®','ä¸»å¾“é–¢ä¿‚','ã‚³ã‚¹ãƒ—ãƒ¬','å¹¼é¦´æŸ“','åˆ¶æœ','ãƒ­ãƒª','ãŠå§‰ã•ã‚“','ã‚®ãƒ£ãƒ«','ãƒ¡ã‚¹ã‚¬ã‚­','æ¸…æ¥š','ç„¡å£','ãƒ„ãƒ³ãƒ‡ãƒ¬','ç”·ã®å¨˜','çœ¼é¡','ãƒ­ãƒ¼ã‚·ãƒ§ãƒ³','æ±—','å›ã','é¦–çµã‚','å‘½ä»¤','ç·Šç¸›','M','S','ã‚­ã‚¹','ãƒã‚°','ã±ã£ã¤ã‚“','ãƒœãƒ–','ã‚½ãƒƒã‚¯ã‚¹','é–éª¨','ã¸ã','èƒŒä¸­'];
        const COLORS = { pink: '#ff5d8f', blue: '#6366f1' };
        let bottles = [];
        let quizData = null; // å‡ºé¡Œè€…ã®æ­£è§£ãƒ‡ãƒ¼ã‚¿
        let isSolveMode = false;

        function toggleModal(show) { document.getElementById('ruleModal').style.display = show ? 'flex' : 'none'; }

        function generateRandom20() {
            if(!confirm("ç¾åœ¨ã®ç“¶ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€ãŠã™ã™ã‚20é …ç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            const shuffled = [...ALL_ITEMS].sort(() => 0.5 - Math.random());
            bottles = shuffled.slice(0, 20).map(name => ({
                name: name, color: COLORS.pink, level: 10
            }));
            render();
        }

        function render() {
            const container = document.getElementById('bottleContainer');
            container.innerHTML = '';
            bottles.forEach((b, i) => {
                const card = document.createElement('div');
                card.className = 'bottle-card';
                card.innerHTML = `
                    <div style="font-size:0.8rem; font-weight:bold; height:1.2rem; overflow:hidden;">${b.name}</div>
                    <div style="display:flex; justify-content:center; gap:12px; margin:8px 0;">
                        <div style="width:18px;height:18px;border-radius:50%;background:${COLORS.pink};border:${b.color===COLORS.pink?'2px solid #333':'none'}" onclick="updateColor(${i},'pink')"></div>
                        <div style="width:18px;height:18px;border-radius:50%;background:${COLORS.blue};border:${b.color===COLORS.blue?'2px solid #333':'none'}" onclick="updateColor(${i},'blue')"></div>
                    </div>
                    <div class="bottle-frame">
                        <div class="liquid" style="height:${b.level}%; background:${b.color}; opacity:0.8;"></div>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                        <button class="p-btn" onclick="updateLevel(${i},-10)">-</button>
                        <span style="font-size:0.75rem; font-weight:bold; width:35px;">${b.level}%</span>
                        <button class="p-btn" onclick="updateLevel(${i},10)">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateColor(i, type) { bottles[i].color = COLORS[type]; render(); }
        function updateLevel(i, diff) { bottles[i].level = Math.max(1, Math.min(100, bottles[i].level + diff)); render(); }

        function publishQuiz() {
            const pw = prompt("ã€å‡ºé¡Œè€…ã€‘å›ç­”è€…ãŒå…¥åŠ›ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±ºã‚ã¦ãã ã•ã„");
            if(!pw) return;
            const dataObj = { p: pw, b: bottles };
            const dataStr = btoa(unescape(encodeURIComponent(JSON.stringify(dataObj))));
            const url = window.location.origin + window.location.pathname + '?q=' + dataStr;
            navigator.clipboard.writeText(url).then(() => {
                alert("ã‚¯ã‚¤ã‚ºãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å‹é”ã«é€ã£ã¦å½“ã¦ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚");
            });
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆ¤å®š
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const q = params.get('q');
            if(q) {
                try {
                    quizData = JSON.parse(decodeURIComponent(escape(atob(q))));
                    startSolveMode();
                } catch(e) { console.error("Invalid data"); }
            } else {
                generateRandom20();
            }
        };

        function startSolveMode() {
            isSolveMode = true;
            document.getElementById('nav-make').classList.remove('active');
            document.getElementById('nav-solve').classList.add('active');
            document.getElementById('pageTitle').innerText = "å‹é”ã®æ€§ç™–ã‚’å½“ã¦ã‚ï¼";
            document.getElementById('guideBox').innerHTML = `<span class="box-title">ã€œ éŠã³æ–¹ ã€œ</span><div style="font-size:0.75rem; text-align:center; color:var(--guide-blue);">å‹é”ãŒæ³¨ã„ã ã€Œè‰²ã€ã¨ã€Œé‡ã€ã‚’äºˆæƒ³ã—ã¦æ³¨ãç›´ãã†ï¼<br>æœ€å¾Œã«ç­”ãˆåˆã‚ã›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ã€‚</div>`;
            document.querySelector('.btn-random').style.display = 'none';
            
            // å›ç­”ç”¨ã‚·ãƒ¼ãƒˆã®æº–å‚™ï¼ˆä¸­èº«ã‚’ç©ºã«ã™ã‚‹ï¼‰
            bottles = quizData.b.map(b => ({ name: b.name, color: COLORS.pink, level: 10 }));
            render();
            
            const btn = document.getElementById('actionBtn');
            btn.innerText = "ç­”ãˆåˆã‚ã›ã‚’ã™ã‚‹ï¼";
            btn.onclick = checkAnswer;
        }

        function checkAnswer() {
            const inputPw = prompt("å‡ºé¡Œè€…ãŒæ±ºã‚ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(inputPw !== quizData.p) {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å‹é”ã«èã„ã¦ã¿ã¦ã­ã€‚");
                return;
            }

            let totalDiff = 0;
            const results = bottles.map((myB, i) => {
                const ansB = quizData.b[i];
                // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼šè‰²ãŒé•ãˆã°å•ç­”ç„¡ç”¨ã§ãƒ¬ãƒ™ãƒ«åˆ†ãŒèª¤å·®ã€‚è‰²ãŒåŒã˜ãªã‚‰ãƒ¬ãƒ™ãƒ«ã®å·®åˆ†ã€‚
                let diff = 0;
                if(myB.color !== ansB.color) {
                    diff = myB.level + ansB.level; 
                } else {
                    diff = Math.abs(myB.level - ansB.level);
                }
                totalDiff += Math.min(diff, 100);
                return { name: myB.name, my: myB, ans: ansB, diff: diff };
            });

            const score = Math.max(0, 100 - Math.round(totalDiff / results.length));
            showResult(score, results);
        }

        function showResult(score, results) {
            document.getElementById('setupView').style.display = 'none';
            const area = document.getElementById('resultArea');
            area.style.display = 'block';
            document.getElementById('totalScore').innerText = score + "%";
            
            let rank = ""; let comment = "";
            if(score >= 95) { rank = "ç§°å·ï¼šã€é­‚ã®åŒå­ã€‘"; comment = "ã‚‚ã¯ã‚„æœ¬äººã§ã¯ï¼Ÿæã‚ã—ã„ã»ã©ã®ç†è§£åº¦ã§ã™ã€‚"; }
            else if(score >= 80) { rank = "ç§°å·ï¼šã€æ€§ç™–é‘‘å®šå£«ã€‘"; comment = "ç´ æ™´ã‚‰ã—ã„ï¼å‹é”ã®å—œå¥½ã‚’å®Œç’§ã«æŠŠæ¡ã—ã¦ã„ã¾ã™ã€‚"; }
            else if(score >= 50) { rank = "ç§°å·ï¼šã€è‰¯ãç†è§£è€…ã€‘"; comment = "ãªã‹ãªã‹ã®ç†è§£åº¦ã€‚ã‚‚ã£ã¨æ·±ãè©±ã—åˆãˆã°100ç‚¹ã‚‚è¿‘ã„ï¼"; }
            else { rank = "ç§°å·ï¼šã€è§£é‡ˆé•ã„ã€‘"; comment = "ã‚ã‚Œã‚Œâ€¦ï¼Ÿå…¨ç„¶é•ã„ã¾ã™ã€‚ã‚‚ã£ã¨ä¿®è¡Œï¼ˆä¼šè©±ï¼‰ãŒå¿…è¦ã§ã™ã€‚"; }
            
            document.getElementById('rankTitle').innerText = rank;
            document.getElementById('rankComment').innerText = comment;

            const list = document.getElementById('comparisonList');
            list.innerHTML = results.map(r => `
                <div style="display:flex; align-items:center; justify-content:between; border-bottom:1px solid #eee; padding:10px 0;">
                    <div style="flex:1; font-size:0.7rem; font-weight:bold;">${r.name}</div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div class="bottle-frame" style="transform:scale(0.5); margin:0;"><div class="liquid" style="height:${r.my.level}%; background:${r.my.color}; opacity:0.8;"></div></div>
                        <div style="font-size:0.8rem;">ğŸ†š</div>
                        <div class="bottle-frame" style="transform:scale(0.5); margin:0;"><div class="liquid" style="height:${r.ans.level}%; background:${r.ans.color}; opacity:0.8;"></div></div>
                    </div>
                </div>
            `).join('');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
